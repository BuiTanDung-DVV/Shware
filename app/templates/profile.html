{% extends "base.html" %} {% from "_formhelpers.html" import render_field %} {%
block title %}User Profile{% endblock %} {% block content %}
<div class="profile-container">
  <h2>User Profile</h2>
  <div class="profile-grid">
    <div class="profile-info">
      <h3>Account Information</h3>
      <img
        src="{{ user_info.avatar }}"
        alt="User Avatar"
        class="profile-avatar"
      />
      <p><strong>Username:</strong> {{ user_info.name or 'Not set' }}</p>
      <p><strong>Email:</strong> {{ user_info.email }}</p>
      <p>
        <strong>Member Since:</strong> {{ user_info.registration_date |
        timestamp_to_date }}
      </p>
    </div>
    <div class="profile-update-form">
      <h3>Update Profile</h3>
      <form
        method="POST"
        action="{{ url_for('user_profile.profile') }}"
        id="profile-update-form"
      >
        {{ form.hidden_tag() }}
        <div id="display_name_wrapper">
          {{ render_field(form.display_name) }}
        </div>
        <hr />
        {# Only show password change section if user has a password provider #}
        {% if has_password_provider %}
        <h4>Change Password</h4>
        <p class="text-muted small">
          Leave blank if you don't want to change your password.
        </p>
        <div id="current_password_wrapper">
          {{ render_field(form.current_password) }}
        </div>
        <div id="new_password_wrapper">
          {{ render_field(form.new_password) }}
        </div>
        <div id="confirm_new_password_wrapper">
          {{ render_field(form.confirm_new_password) }}
        </div>
        {% else %}
        <h4>Password Management</h4>
        <p class="text-muted small">
          You are logged in using a third-party provider (like Google).
        </p>
        {% endif %}
        <div id="submit_button_wrapper">{{ render_field(form.submit) }}</div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("profile-update-form");
    const displayNameInput = document.querySelector(
      "#display_name_wrapper input"
    );
    const newPasswordInput = document.querySelector(
      "#new_password_wrapper input"
    ); // Might be null
    const submitButton = document.querySelector(
      "#submit_button_wrapper input[type='submit']"
    );

    // Store the initial value of the display name
    const initialDisplayName = displayNameInput ? displayNameInput.value : "";

    // Function to check if the form has changed
    function checkForChanges() {
      let hasChanged = false;
      const currentDisplayName = displayNameInput ? displayNameInput.value : "";
      const currentNewPassword = newPasswordInput ? newPasswordInput.value : "";

      // Check if display name changed OR new password has content
      if (
        currentDisplayName !== initialDisplayName ||
        (newPasswordInput && currentNewPassword.length > 0)
      ) {
        hasChanged = true;
      }

      // Enable/disable the button based on changes
      if (submitButton) {
        submitButton.disabled = !hasChanged;
      }
    }

    // Initially disable the button
    if (submitButton) {
      submitButton.disabled = true;
    }

    // Add event listeners to the relevant fields
    if (displayNameInput) {
      displayNameInput.addEventListener("input", checkForChanges);
    }
    if (newPasswordInput) {
      newPasswordInput.addEventListener("input", checkForChanges);
    }

    // Also check on form reset
    if (form) {
      form.addEventListener("reset", () => {
        setTimeout(() => {
          if (submitButton) submitButton.disabled = true;
        }, 0);
      });
    }
  });
</script>

{% endblock %}
