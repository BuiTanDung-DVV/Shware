{% extends "base.html" %} {% from "_formhelpers.html" import render_field %} {%
block title %}User Profile{% endblock %} {% block content %}
<div class="profile-container">
  <h2>User Dashboard</h2>
  <ul class="nav nav-tabs" id="profileTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="profile-tab"
        data-bs-toggle="tab"
        data-bs-target="#profile"
        type="button"
        role="tab"
        aria-controls="profile"
        aria-selected="true"
      >
        User Profile
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="uploads-tab"
        data-bs-toggle="tab"
        data-bs-target="#uploads"
        type="button"
        role="tab"
        aria-controls="uploads"
        aria-selected="false"
      >
        Uploads
      </button>
    </li>
  </ul>
  <div class="tab-content" id="profileTabsContent">
    <div
      class="tab-pane fade show active"
      id="profile"
      role="tabpanel"
      aria-labelledby="profile-tab"
    >
      <!-- Nội dung của tab User Profile -->
      <div class="profile-grid">
        <div class="profile-info">
          <h3>Account Information</h3>
          <img
            src="{{ user_info.avatar }}"
            alt="User Avatar"
            class="profile-avatar"
          />
          <p><strong>Username:</strong> {{ user_info.name or 'Not set' }}</p>
          <p><strong>Email:</strong> {{ user_info.email }}</p>
          <p>
            <strong>Member Since:</strong> {{ user_info.registration_date |
            timestamp_to_date }}
          </p>
        </div>
        <div class="profile-update-form">
          <h3>Update Profile</h3>
          <form
            method="POST"
            action="{{ url_for('user_profile.profile') }}"
            id="profile-update-form"
          >
            {{ form.hidden_tag() }}
            <div id="display_name_wrapper">
              {{ render_field(form.display_name) }}
            </div>
            <hr />
            {% if has_password_provider %}
            <h4>Change Password</h4>
            <p class="text-muted small">
              Leave blank if you don't want to change your password.
            </p>
            <div id="current_password_wrapper">
              {{ render_field(form.current_password) }}
            </div>
            <div id="new_password_wrapper">
              {{ render_field(form.new_password) }}
            </div>
            <div id="confirm_new_password_wrapper">
              {{ render_field(form.confirm_new_password) }}
            </div>
            {% else %}
            <h4>Password Management</h4>
            <p class="text-muted small">
              You are logged in using a third-party provider (like Google).
            </p>
            {% endif %}
            <div id="submit_button_wrapper">
              {{ render_field(form.submit) }}
            </div>
          </form>
        </div>
      </div>
    </div>
    <div
      class="tab-pane fade"
      id="uploads"
      role="tabpanel"
      aria-labelledby="uploads-tab"
    >
      <!-- Nội dung của tab Uploads -->
      <h3>Your Uploads</h3>
      {% if user_uploads %}
      <ul class="uploads-list-detailed">
        {% for file in user_uploads %}
        <li class="upload-item">
          <a
            href="{{ url_for('files.file_detail', doc_id=file.doc_id) }}"
            class="upload-item-title"
            >{{ file.title }}</a
          >
          <span class="upload-item-date"
            >{{ file.upload_date | format_datetime }}</span
          >
          {# Assuming you have a format_datetime filter #}
          <div class="upload-item-actions">
            <a
              href="#"
              class="btn btn-sm btn-outline-secondary action-btn"
              title="Edit"
            >
              {# Placeholder link for Edit #}
              <i class="fas fa-edit"></i>
            </a>
            <form
              method="POST"
              action="{{ url_for('files.delete_file', doc_id=file.doc_id) }}"
              style="display: inline"
              onsubmit="return confirm('Are you sure you want to delete this file?');"
            >
              <button
                type="submit"
                class="btn btn-sm btn-outline-danger action-btn"
                title="Delete"
              >
                <i class="fas fa-trash"></i>
              </button>
            </form>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>You have not uploaded any files yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Check if there's an anchor in the URL
    const hash = window.location.hash;
    let tabToActivate = null;

    if (hash) {
      // Try to find a tab button whose data-bs-target matches the hash
      tabToActivate = document.querySelector(
        `.nav-tabs button[data-bs-target="${hash}"]`
      );
    }

    // If a matching tab was found based on the hash, activate it
    if (tabToActivate) {
      const tab = new bootstrap.Tab(tabToActivate);
      tab.show();
    } else {
      // Otherwise, default to showing the first tab (User Profile)
      const defaultTabButton = document.querySelector("#profileTabs .nav-link"); // Select the first tab link
      if (defaultTabButton) {
        const defaultTab = new bootstrap.Tab(defaultTabButton);
        defaultTab.show();
      }
    }

    // Optional: Update URL hash when a tab is shown (without page jump)
    const tabButtons = document.querySelectorAll(
      '#profileTabs button[data-bs-toggle="tab"]'
    );
    tabButtons.forEach((button) => {
      button.addEventListener("shown.bs.tab", function (event) {
        const newHash = event.target.getAttribute("data-bs-target");
        if (history.pushState) {
          // Use pushState to change hash without scrolling
          history.pushState(null, null, newHash);
        } else {
          // Fallback for older browsers (might cause jump)
          window.location.hash = newHash;
        }
      });
    });
  });
</script>

{% endblock %}
