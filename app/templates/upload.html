{% extends 'base.html' %} {% block content %}
<main>
  <div class="auth-form">
    <h2>üöÄ T·∫£i l√™n File</h2>
    <form
      action="{{ url_for('upload.upload_file') }}"
      method="post"
      enctype="multipart/form-data"
      id="uploadForm"
    >
      <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="flashes">
        {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <!-- File Upload -->
      <div class="form-group">
        <label for="file">Ch·ªçn t·ªáp (.zip, .rar) *</label>
        <input type="file" id="file" name="file" accept=".zip, .rar" required />
      </div>

      <!-- Thumbnail Upload -->
      <div class="form-group">
        <label for="thumbnail">·∫¢nh n·ªÅn (thumbnail)</label>
        <div class="thumbnail-preview-container">
          <img
            id="thumbnail-preview"
            src="/static/images/default-thumbnail.png"
            alt="Preview"
          />
        </div>
        <input type="file" id="thumbnail" name="thumbnail" accept="image/*" />
        <small class="form-text"
          >H√¨nh ·∫£nh ƒë·∫°i di·ªán cho file c·ªßa b·∫°n (t√πy ch·ªçn)</small
        >
      </div>

      <!-- Title -->
      <div class="form-group">
        <label for="title">Ti√™u ƒë·ªÅ *</label>
        <input
          type="text"
          id="title"
          name="title"
          placeholder="Nh·∫≠p ti√™u ƒë·ªÅ t·ªáp"
          required
        />
      </div>

      <!-- Author - Auto-filled and readonly -->
      <div class="form-group">
        <label for="author">T√°c gi·∫£</label>
        <input
          type="text"
          id="author"
          name="author"
          value="{{ current_user.name }}"
          readonly
        />
        <small class="form-text">T·ª± ƒë·ªông l·∫•y t·ª´ t√†i kho·∫£n c·ªßa b·∫°n</small>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description">M√¥ t·∫£ *</label>
        <textarea
          id="description"
          name="description"
          rows="3"
          placeholder="Nh·∫≠p m√¥ t·∫£ t·ªáp"
          required
        ></textarea>
      </div>

      <!-- Tags as checkboxes - Improved UI -->
      <div class="form-group">
        <label>Th·∫ª (ch·ªçn √≠t nh·∫•t m·ªôt) *</label>
        <div class="tags-container">
          <div class="tag-item">
            <input
              type="checkbox"
              id="tag-congnghe"
              name="tags"
              value="c√¥ng ngh·ªá"
            />
            <label for="tag-congnghe">C√¥ng ngh·ªá</label>
          </div>
          <div class="tag-item">
            <input
              type="checkbox"
              id="tag-giaoduc"
              name="tags"
              value="gi√°o d·ª•c"
            />
            <label for="tag-giaoduc">Gi√°o d·ª•c</label>
          </div>
          <div class="tag-item">
            <input
              type="checkbox"
              id="tag-phanmem"
              name="tags"
              value="ph·∫ßn m·ªÅm"
            />
            <label for="tag-phanmem">Ph·∫ßn m·ªÅm</label>
          </div>
          <div class="tag-item">
            <input
              type="checkbox"
              id="tag-tailieukhac"
              name="tags"
              value="t√†i li·ªáu kh√°c"
            />
            <label for="tag-tailieukhac">T√†i li·ªáu kh√°c</label>
          </div>
        </div>
        <!-- Custom tag input -->
        <div class="custom-tag">
          <input type="text" id="custom-tag" placeholder="Th√™m th·∫ª t√πy ch·ªânh" />
          <button type="button" id="add-custom-tag" class="btn btn-sm">
            +
          </button>
        </div>
        <div id="custom-tags-container"></div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">üì§ T·∫£i l√™n</button>
      </div>
    </form>

    <div class="auth-links">
      <a href="{{ url_for('user_profile.profile', _anchor='uploads') }}"
        >üìÅ Xem Danh S√°ch File</a
      >
    </div>
  </div>
</main>

<style>
  .thumbnail-preview-container {
    width: 200px;
    height: 150px;
    border: 1px dashed var(--border-color);
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: var(--light-color);
  }

  #thumbnail-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 10px;
  }

  .tag-item {
    display: flex;
    align-items: center;
    background-color: var(--light-color);
    padding: 3px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-color); /* S·ª≠ d·ª•ng bi·∫øn CSS cho m√†u ch·ªØ */
    border: 1px solid var(--border-color);
  }

  .tag-item:hover {
    background-color: var(--dropdown-item-hover-bg);
    color: var(--dropdown-item-hover-text);
  }

  .tag-item input[type="checkbox"] {
    margin-right: 4px;
  }

  .tag-item label {
    cursor: pointer;
    color: inherit; /* K·∫ø th·ª´a m√†u t·ª´ ph·∫ßn t·ª≠ cha */
  }

  .custom-tag {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
  }

  #custom-tag {
    flex-grow: 1;
    padding: 4px 8px;
    font-size: 0.9rem;
    background-color: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 4px;
  }

  #add-custom-tag {
    padding: 2px 8px;
    font-size: 0.9rem;
    background-color: var(--light-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
  }

  #custom-tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 6px;
  }

  .custom-tag-item {
    background-color: var(--primary-color);
    padding: 3px 8px;
    border-radius: 3px;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    color: white; /* S·ª≠ d·ª•ng m√†u tr·∫Øng cho tag t√πy ch·ªânh ƒë·ªÉ n·ªïi b·∫≠t */
  }

  .remove-tag {
    margin-left: 4px;
    cursor: pointer;
    color: white;
    font-weight: bold;
  }

  /* Styling for readonly author field */
  input[readonly] {
    background-color: var(--light-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
  }

  .form-text {
    color: var(--text-color);
    opacity: 0.7;
    font-size: 0.8rem;
    margin-top: 3px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Thumbnail preview
    const thumbnailInput = document.getElementById("thumbnail");
    const thumbnailPreview = document.getElementById("thumbnail-preview");

    thumbnailInput.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          thumbnailPreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Custom tags functionality
    const customTagInput = document.getElementById("custom-tag");
    const addCustomTagBtn = document.getElementById("add-custom-tag");
    const customTagsContainer = document.getElementById(
      "custom-tags-container"
    );

    addCustomTagBtn.addEventListener("click", function () {
      const tagValue = customTagInput.value.trim();
      if (tagValue) {
        addCustomTag(tagValue);
        customTagInput.value = "";
      }
    });

    customTagInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        addCustomTagBtn.click();
      }
    });

    function addCustomTag(tagValue) {
      // Create hidden input for form submission
      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.name = "tags";
      hiddenInput.value = tagValue;

      // Create visual tag item
      const tagItem = document.createElement("div");
      tagItem.className = "custom-tag-item";
      tagItem.innerHTML = `
            ${tagValue}
            <span class="remove-tag">&times;</span>
        `;

      // Add remove functionality
      const removeBtn = tagItem.querySelector(".remove-tag");
      removeBtn.addEventListener("click", function () {
        tagItem.remove();
        hiddenInput.remove();
      });

      customTagsContainer.appendChild(tagItem);
      tagItem.appendChild(hiddenInput);
    }
  });
</script>
{% endblock %}
