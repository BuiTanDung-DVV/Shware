{% extends 'base.html' %}

{% block content %}
<main>
  <div class="auth-form">
    <h2>üìù T·∫°o B√†i Vi·∫øt M·ªõi</h2>
    <form action="{{ url_for('post.create_post') }}" method="post" enctype="multipart/form-data" id="postForm">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flashes">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Ti√™u ƒë·ªÅ -->
      <div class="form-group">
        <label for="title">Ti√™u ƒë·ªÅ <span class="required">*</span></label>
        <input type="text" id="title" name="title" required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt" maxlength="100">
        <small class="form-text text-muted">T·ªëi ƒëa 100 k√Ω t·ª±</small>
      </div>

      <!-- Danh m·ª•c -->
      <div class="form-group">
        <label for="category">Danh m·ª•c <span class="required">*</span></label>
        <select id="category" name="category" required>
          {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- N·ªôi dung -->
      <div class="form-group">
        <label for="content">N·ªôi dung <span class="required">*</span></label>
        <div class="editor-toolbar">
          <button type="button" onclick="formatText('bold')" title="Ch·ªØ ƒë·∫≠m"><i class="fas fa-bold"></i></button>
          <button type="button" onclick="formatText('italic')" title="Ch·ªØ nghi√™ng"><i class="fas fa-italic"></i></button>
          <button type="button" onclick="formatText('heading')" title="Ti√™u ƒë·ªÅ"><i class="fas fa-heading"></i></button>
          <button type="button" onclick="formatText('list')" title="Danh s√°ch"><i class="fas fa-list"></i></button>
          <button type="button" onclick="formatText('link')" title="Li√™n k·∫øt"><i class="fas fa-link"></i></button>
        </div>
        <textarea id="content" name="content" rows="8" required placeholder="Vi·∫øt n·ªôi dung b√†i vi·∫øt ·ªü ƒë√¢y..."></textarea>
        <small class="form-text text-muted">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng Markdown c∆° b·∫£n</small>
      </div>

      <!-- M√¥ t·∫£ -->
      <div class="form-group">
        <label for="description">M√¥ t·∫£ ng·∫Øn <span class="required">*</span></label>
        <textarea id="description" name="description" rows="3" required placeholder="T√≥m t·∫Øt ng·∫Øn g·ªçn b√†i vi·∫øt..." maxlength="250"></textarea>
        <div class="char-counter"><span id="descriptionCounter">0</span>/250</div>
      </div>

      <!-- ·∫¢nh Thumbnail -->
      <div class="form-group">
        <label for="thumbnail">·∫¢nh ƒë·∫°i di·ªán</label>
        <div class="file-upload-wrapper">
          <input type="file" id="thumbnail" name="thumbnail" accept="image/*" class="file-upload-input">
          <div class="file-upload-preview">
            <img id="thumbnailPreview" src="#" alt="Preview" style="display: none; max-width: 100%; max-height: 200px;">
          </div>
          <div class="file-upload-controls">
            <label for="thumbnail" class="btn btn-outline">Ch·ªçn ·∫£nh</label>
            <button type="button" id="removeThumbnail" class="btn btn-danger" style="display: none;">X√≥a</button>
          </div>
        </div>
        <small class="form-text text-muted">ƒê·ªãnh d·∫°ng h·ªó tr·ª£: PNG, JPG, JPEG, GIF, WEBP. K√≠ch th∆∞·ªõc t·ªëi ƒëa: 5MB</small>
      </div>

      <!-- T·ªáp ƒë√≠nh k√®m -->
      <div class="form-group">
        <label for="attachment">File ƒë√≠nh k√®m</label>
        <div class="file-upload-wrapper">
          <input type="file" id="attachment" name="attachment" accept=".zip,.rar,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" class="file-upload-input">
          <div class="file-upload-controls">
            <label for="attachment" class="btn btn-outline">Ch·ªçn file</label>
            <span id="selectedFileName" class="ml-2"></span>
            <button type="button" id="removeAttachment" class="btn btn-danger" style="display: none;">X√≥a</button>
          </div>
        </div>
        <small class="form-text text-muted">ƒê·ªãnh d·∫°ng h·ªó tr·ª£: ZIP, RAR, PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX. K√≠ch th∆∞·ªõc t·ªëi ƒëa: 10MB</small>
      </div>

      <!-- Th·∫ª -->
      <div class="form-group">
        <label for="tags">Th·∫ª</label>
        <div class="tags-input-container">
          <input type="text" id="tagInput" placeholder="Th√™m th·∫ª v√† nh·∫•n Enter">
          <div id="tagsContainer" class="tags-container"></div>
          <input type="hidden" id="tags" name="tags">
        </div>
        <small class="form-text text-muted">T·ªëi ƒëa 5 th·∫ª, m·ªói th·∫ª t·ªëi ƒëa 20 k√Ω t·ª±</small>
      </div>

      <!-- Submit -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="previewBtn">üëÅÔ∏è Xem tr∆∞·ªõc</button>
        <button type="submit" class="btn btn-primary">üì§ ƒêƒÉng B√†i</button>
        <button type="button" class="btn btn-outline" id="saveAsDraft">üíæ L∆∞u nh√°p</button>
      </div>
    </form>

    <div class="auth-links">
      <a href="{{ url_for('post.list_posts') }}">üìö Xem Danh S√°ch B√†i Vi·∫øt</a>
    </div>
  </div>
</main>

<!-- Xem tr∆∞·ªõc Modal -->
<div id="previewModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Xem Tr∆∞·ªõc B√†i Vi·∫øt</h2>
    <div class="preview-container">
      <h1 id="previewTitle"></h1>
      <div class="preview-meta">
        <span class="category" id="previewCategory"></span>
        <span class="date">{{ now.strftime('%d/%m/%Y') }}</span>
      </div>
      <div id="previewThumbnail" class="preview-thumbnail"></div>
      <div id="previewContent" class="preview-content"></div>
      <blockquote id="previewDescription" class="preview-description"></blockquote>
      <div id="previewTags" class="preview-tags"></div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-primary" id="editFromPreview">Ch·ªânh s·ª≠a</button>
      <button type="button" class="btn btn-success" id="publishFromPreview">ƒêƒÉng b√†i</button>
    </div>
  </div>
</div>

<script>
// X·ª≠ l√Ω preview ·∫£nh thumbnail
document.getElementById('thumbnail').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.getElementById('thumbnailPreview');
      preview.src = e.target.result;
      preview.style.display = 'block';
      document.getElementById('removeThumbnail').style.display = 'inline-block';
    }
    reader.readAsDataURL(file);
  }
});

// X·ª≠ l√Ω x√≥a thumbnail
document.getElementById('removeThumbnail').addEventListener('click', function() {
  document.getElementById('thumbnail').value = '';
  document.getElementById('thumbnailPreview').style.display = 'none';
  this.style.display = 'none';
});

// Hi·ªÉn th·ªã t√™n file ƒë√≠nh k√®m
document.getElementById('attachment').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    document.getElementById('selectedFileName').textContent = file.name;
    document.getElementById('removeAttachment').style.display = 'inline-block';
  }
});

// X·ª≠ l√Ω x√≥a file ƒë√≠nh k√®m
document.getElementById('removeAttachment').addEventListener('click', function() {
  document.getElementById('attachment').value = '';
  document.getElementById('selectedFileName').textContent = '';
  this.style.display = 'none';
});

// X·ª≠ l√Ω ƒë·∫øm k√Ω t·ª± cho m√¥ t·∫£
document.getElementById('description').addEventListener('input', function() {
  const count = this.value.length;
  document.getElementById('descriptionCounter').textContent = count;

  if (count > 250) {
    this.value = this.value.substring(0, 250);
    document.getElementById('descriptionCounter').textContent = 250;
  }
});

// X·ª≠ l√Ω th·∫ª tags
const tagInput = document.getElementById('tagInput');
const tagsContainer = document.getElementById('tagsContainer');
const tagsField = document.getElementById('tags');
let tags = [];

tagInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const tag = this.value.trim().toLowerCase();

    if (tag && !tags.includes(tag) && tags.length < 5) {
      tags.push(tag);
      updateTags();
    }

    this.value = '';
  }
});

function updateTags() {
  tagsContainer.innerHTML = '';
  tags.forEach(tag => {
    const tagElement = document.createElement('span');
    tagElement.classList.add('tag');
    tagElement.innerHTML = `${tag} <span class="tag-remove" data-tag="${tag}">&times;</span>`;
    tagsContainer.appendChild(tagElement);
  });

  tagsField.value = tags.join(',');

  // Add event listeners to the remove buttons
  document.querySelectorAll('.tag-remove').forEach(button => {
    button.addEventListener('click', function() {
      const tagToRemove = this.getAttribute('data-tag');
      tags = tags.filter(tag => tag !== tagToRemove);
      updateTags();
    });
  });
}

// ƒê·ªãnh d·∫°ng vƒÉn b·∫£n
function formatText(format) {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  let replacement = '';

  switch(format) {
    case 'bold':
      replacement = `**${selectedText}**`;
      break;
    case 'italic':
      replacement = `*${selectedText}*`;
      break;
    case 'heading':
      replacement = `## ${selectedText}`;
      break;
    case 'list':
      replacement = `- ${selectedText.split('\n').join('\n- ')}`;
      break;
    case 'link':
      const url = prompt('Nh·∫≠p URL:', 'https://');
      if (url) {
        replacement = `[${selectedText || 'Li√™n k·∫øt'}](${url})`;
      } else {
        return;
      }
      break;
  }

  textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
  textarea.focus();
  textarea.selectionStart = start + replacement.length;
  textarea.selectionEnd = start + replacement.length;
}

// X·ª≠ l√Ω xem tr∆∞·ªõc
document.getElementById('previewBtn').addEventListener('click', function() {
  const title = document.getElementById('title').value;
  const category = document.getElementById('category').value;
  const content = document.getElementById('content').value;
  const description = document.getElementById('description').value;

  if (!title || !content || !description) {
    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!');
    return;
  }

  // Convert markdown to HTML (basic implementation)
  const contentHtml = markdownToHtml(content);

  document.getElementById('previewTitle').textContent = title;
  document.getElementById('previewCategory').textContent = category;
  document.getElementById('previewContent').innerHTML = contentHtml;
  document.getElementById('previewDescription').textContent = description;

  // Display tags
  const previewTags = document.getElementById('previewTags');
  previewTags.innerHTML = '';
  tags.forEach(tag => {
    const tagSpan = document.createElement('span');
    tagSpan.textContent = `#${tag}`;
    previewTags.appendChild(tagSpan);
  });

  // Display thumbnail if available
  const thumbnailPreview = document.getElementById('thumbnailPreview');
  const previewThumbnail = document.getElementById('previewThumbnail');
  if (thumbnailPreview.style.display !== 'none') {
    const img = document.createElement('img');
    img.src = thumbnailPreview.src;
    previewThumbnail.innerHTML = '';
    previewThumbnail.appendChild(img);
  } else {
    previewThumbnail.innerHTML = '';
  }

  // Show modal
  document.getElementById('previewModal').style.display = 'block';
});

// Basic markdown to HTML converter
function markdownToHtml(markdown) {
  // Handle headings
  markdown = markdown.replace(/^## (.*$)/gm, '<h2>$1</h2>');
  markdown = markdown.replace(/^# (.*$)/gm, '<h1>$1</h1>');

  // Handle bold
  markdown = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  // Handle italic
  markdown = markdown.replace(/\*(.*?)\*/g, '<em>$1</em>');

  // Handle links
  markdown = markdown.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');

  // Handle lists
  markdown = markdown.replace(/^\- (.*$)/gm, '<li>$1</li>');
  markdown = markdown.replace(/<li>(.*)<\/li>/g, '<ul><li>$1</li></ul>');

  // Handle paragraphs
  markdown = markdown.replace(/^(?!<[a-z])(.*$)/gm, '<p>$1</p>');

  return markdown;
}

// Close the modal
document.querySelector('.close').addEventListener('click', function() {
  document.getElementById('previewModal').style.display = 'none';
});

// Close modal when clicking outside
window.addEventListener('click', function(event) {
  const modal = document.getElementById('previewModal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
});

// Edit from preview
document.getElementById('editFromPreview').addEventListener('click', function() {
  document.getElementById('previewModal').style.display = 'none';
});

// Publish from preview
document.getElementById('publishFromPreview').addEventListener('click', function() {
  document.getElementById('postForm').submit();
});

// Save as draft
document.getElementById('saveAsDraft').addEventListener('click', function() {
  const draftInput = document.createElement('input');
  draftInput.type = 'hidden';
  draftInput.name = 'status';
  draftInput.value = 'draft';
  document.getElementById('postForm').appendChild(draftInput);
  document.getElementById('postForm').submit();
});
</script>

<style>
.form-group {
  margin-bottom: 1.5rem;
}

.required {
  color: #ff4757;
}

.form-text {
  margin-top: 0.25rem;
  font-size: 0.875rem;
}

.char-counter {
  text-align: right;
  font-size: 0.875rem;
  color: #777;
}

.file-upload-wrapper {
  margin-top: 0.5rem;
}

.file-upload-input {
  display: none;
}

.file-upload-controls {
  display: flex;
  align-items: center;
  margin-top: 0.5rem;
}

.btn-outline {
  border: 1px solid #ccc;
  background: none;
  padding: 0.5rem 1rem;
  cursor: pointer;
}

.btn-danger {
  background-color: #ff4757;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  margin-left: 0.5rem;
  cursor: pointer;
}

.tags-input-container {
  margin-top: 0.5rem;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  margin-top: 0.5rem;
  gap: 0.5rem;
}

.tag {
  background-color: #f1f1f1;
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  display: inline-flex;
  align-items: center;
}

.tag-remove {
  margin-left: 0.25rem;
  cursor: pointer;
  font-weight: bold;
}

.editor-toolbar {
  border: 1px solid #ccc;
  border-bottom: none;
  background-color: #f9f9f9;
  padding: 0.5rem;
  display: flex;
  gap: 0.5rem;
}

.editor-toolbar button {
  background: none;
  border: none;
  padding: 0.25rem 0.5rem;
  cursor: pointer;
}

.editor-toolbar button:hover {
  background-color: #e9e9e9;
}

textarea#content {
  border-top: none;
  resize: vertical;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 2rem;
  border-radius: 8px;
  width: 80%;
  max-width: 900px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.close {
  float: right;
  font-size: 1.5rem;
  font-weight: bold;
  cursor: pointer;
}

.preview-container {
  margin-top: 1.5rem;
  border: 1px solid #eee;
  padding: 2rem;
  border-radius: 4px;
}

.preview-meta {
  margin-bottom: 1rem;
  color: #777;
  font-size: 0.875rem;
}

.preview-thumbnail {
  margin-bottom: 1.5rem;
}

.preview-thumbnail img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
}

.preview-content {
  line-height: 1.6;
  margin-bottom: 1.5rem;
}

.preview-description {
  background-color: #f9f9f9;
  padding: 1rem;
  border-left: 4px solid #ddd;
  margin-bottom: 1.5rem;
}

.preview-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}

.preview-tags span {
  background-color: #f1f1f1;
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.modal-actions {
  margin-top: 1.5rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.btn-success {
  background-color: #28a745;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  cursor: pointer;
}
</style>
{% endblock %}